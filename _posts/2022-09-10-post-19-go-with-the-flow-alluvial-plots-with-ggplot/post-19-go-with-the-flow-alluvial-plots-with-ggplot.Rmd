---
title: "Post #19. Go with the flow - alluvial diagrams in ggplot"
description: |
  Let's create flowy alluvial diagrams in ggplot using the extension package `ggalluvial`!
author:
  - name: Gen-Chang Hsu
date: 2022-09-10
output:
  distill::distill_article:
    self_contained: false
categories:
  - "2022"
preview: ../../homepage_images/Post19.png
draft: True
---

<!-- Webpage style -->
<style>
d-article a {
    color: #2780e3 !important;
    border-bottom: none !important;
}

d-article a:hover {
    color: #2780e3 !important;
    border-bottom: 2px solid !important;
}

d-byline {
    margin-left: -10% !important;
}

d-title {
    margin-left: -10%;
}

d-title h1{
    font-size: 45px;
    width: 130%;
}

d-article {
    margin-left: -10%;
}

p {
    width: 120%;
}

d-article h2 {
    width: 120%;
}

d-article h3 {
  width: 120%;
  font-size: 28px;
}

div.article-footer{
    width: 120%;
}

d-article div.sourceCode { 
    width: 120% !important;
}

d-article pre { 
    width: 120% !important;
}

div.l-body {
    width: 120% !important;
}

div.l-body img {
    margin-right: 20% !important;
}

</style>

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = F, 
                      error = F, 
                      warning = F,
                      fig.align = "center")

```

<!-- Start of the article -->

## Introduction

An alluvial diagram is a type of chart that shows the relationships between levels of categorical variables for a given quantity (number of people, amount of energy, etc.) It looks like a stacked barplot with flow streams connecting the stacks of adjacent bars (that's why it gets its name!). Alluvial diagrams are useful for visualizing pathways and trends across variables. Another similar chart is [bump charts](https://genchanghsu.github.io/ggGallery/posts/2022-08-01-post-18-bump-charts-with-ggplot/), which emphasize the change in rankings of multiple objects over time. 

## Create alluvial diagrams with `ggalluvial`

We'll be using the extension package [`ggalluvial`](https://corybrunson.github.io/ggalluvial/) to create alluvial diagrams in ggplot. The functions in `ggalluvial` can take data in both wide and long format, and we'll start with the wide format here. 

First, let's prepare our data using the `diamonds` dataset: We'll convert the carat of the diamonds into "Large" and "Small" as well as the price into "Low", "Mid", and "High", and tally the numbers of diamonds by carat, cut, and price.

```{r, fig.width = 9, fig.height = 5, out.width = "85%"}
library(tidyverse)

# Prepare wide-format diamonds data
diamonds_wide <- diamonds %>% 
  mutate(price_cat = case_when(price < quantile(price, 0.33) ~ "Low",
                               price > quantile(price, 0.67) ~ "High",
                               TRUE ~ "Mid"),
         price_cat = factor(price_cat, levels = c("High", "Mid", "Low")),
         carat_cat = ifelse(carat > median(carat), "Large", "Small"),
         cut = fct_rev(cut)) %>% 
  group_by(carat_cat, cut, price_cat) %>%
  summarise(count = n()) %>% 
  ungroup()

head(diamonds_wide)

```

With the appropriate data on hand, we can now visualize the relationships between carat, cut, and price in an alluvial diagram. There are a few things worth noting:

<span style="display: block; margin-top: 3px; margin-left: 10px"> (1) The flow streams and bars are drawn using `geom_alluvium()` and `geom_stratum()`, respectively</span>
<span style="display: block; margin-top: 5px; margin-left: 10px"> (2) The bars are positioned along the horizontal axis using the arguments `axis1`, `axis2`, ... in `aes()`</span>
<span style="display: block; margin-top: 5px; margin-left: 10px"> (3) The function `geom_stratum()` will create a new internal variable "`stratum`" that can be used to label the bars by specifying `label = after_stat(stratum)` in `geom_text()`</span>
<span style="display: block; margin-top: 5px; margin-left: 10px"> (4) The alluvia are colored by price</span>

```{r, fig.width = 8, fig.height = 4, out.width = "85%"}
# install.packages("ggalluvial")  # install the package if you haven't
library(ggalluvial)
library(scales)  # for the function "comma_format()"

ggplot(diamonds_wide, aes(axis1 = carat_cat, axis2 = cut, axis3 = price_cat, y = count)) +
  geom_alluvium(aes(fill = price_cat), width = 1/5) +
  geom_stratum(width = 1/5, fill = "#fee6ce", color = "black") +
  geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2.5) +
  scale_x_discrete(limits = c("Carat", "Cut", "Price"), expand = c(0, 0.2)) +
  scale_y_continuous(expand = c(0, 0), labels = comma_format()) + 
  labs(y = "Count") + 
  scale_fill_brewer(name = "Price", palette = "Set1") + 
  theme_classic(base_size = 13) + 
  theme(axis.line.x = element_blank(),
        axis.ticks.x = element_blank())

```
It seems that no large diamond has a low price and no small diamond has a high price, regardless of the cut quality.

From this plot, we can further adjust the width of the bars, the knot position (the inflection point) of the flow streams, and the orientation of the diagram to produce the so-called ["parallel sets"](https://dataforvisualization.com/charts/parallel-sets-plot/).

```{r, fig.width = 7, fig.height = 5, out.width = "75%"}
ggplot(diamonds_wide, aes(axis1 = carat_cat, axis2 = cut, axis3 = price_cat, y = count)) +
  geom_alluvium(aes(fill = price_cat), width = 0, knot.pos = 0, show.legend = F) +  # knot.pos = 0 produces straight flow streams
  geom_stratum(width = 0.02, fill = "black", color = "white") +  # reduce the bar width to create thick lines
  geom_text(stat = "stratum", aes(label = after_stat(stratum)), size = 2.5, nudge_x = 0.05) +
  scale_x_discrete(limits = c("Carat", "Cut", "Price"), expand = c(0, 0.1)) +
  scale_y_continuous(expand = c(0, 0), labels = comma_format()) + 
  labs(y = "Count") + 
  scale_fill_brewer(palette = "Set1") + 
  coord_flip() +  # flip the plot
  theme_classic(base_size = 13) + 
  theme(axis.line.y = element_blank(),
        axis.ticks.y = element_blank())

```






As mentioned earlier, we can also pass data in long format to the function. We need to add an ID to each row and convert the wide data into long format. The specifications for it are a bit different from the previous ones:

<span style="display: block; margin-top: 3px; margin-left: 10px"> (1) Create a stacked barplot of journals' impact factors over year</span>
<span style="display: block; margin-top: 5px; margin-left: 10px"> (2) Compute the curves that connect the upper/lower ends of the bars for each journal</span>
<span style="display: block; margin-top: 5px; margin-left: 10px"> (3) Add ribbons to the stacked barplot</span>
<span style="display: block; margin-top: 5px; margin-left: 10px"> (4) Polish the appearance of the chart</span>

The main advantage of using this method is that now we can color the flows between adjacent bars (strata) based on each variable

 
```{r, fig.width = 7, fig.height = 4, out.width = "85%"}

diamonds_long <- diamonds_wide %>%
  mutate(alluvium = row_number()) %>% 
  pivot_longer(-c(count, alluvium))

ggplot(diamonds_long, aes(x = name, y = count, stratum = value, alluvium = alluvium)) +
  geom_flow(aes(fill = value)) +
  geom_stratum(aes(fill = value), alpha = .5) +
  geom_text(stat = "stratum", aes(label = value), size = 3) +
  scale_x_discrete(labels = c("Carat", "Cut", "Price"), expand = c(0, 0.2)) +
  scale_y_continuous(expand = c(0, 0), labels = comma_format()) + 
  labs(x = "", y = "Count") +
  guides(fill = "none") + 
  theme_classic(base_size = 13) + 
  theme(axis.line.x = element_blank(),
        axis.ticks.x = element_blank())

```


## Summary

To recap what we've done in this post, we started by creating a standard alluvial diagram with wide format `diamonds` data using the package `ggalluvial`. We then modified the diagram to produce "parallel sets". Finally, we've converted the data into long format and create another alluvial diagram that had different flow stream colors between adjacent bars.

Again, alluvial diagrams are best for visualizing the relationships between categorical variables. And if the bars are ordered along the axis, for example, by time, distance, or some kind of environmental gradients, the diagrams can help reveal trends.

Hope you learn something useful from this post and don't forget to leave your comments and suggestions below if you have any!
