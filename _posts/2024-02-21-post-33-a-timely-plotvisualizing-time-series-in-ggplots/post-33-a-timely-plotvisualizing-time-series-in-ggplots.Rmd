---
title: 'Post #33. A "timely" plotâ€”Visualizing time series data in ggplots'
description: |
  Create an awesome time series chart in ggplots.
author:
  - name: Gen-Chang Hsu
date: 2024-02-21
output:
  distill::distill_article:
    self_contained: false
categories:
  - "2024"
preview: ../../homepage_images/Post33.png
draft: true
---

<!-- Webpage style -->

<style>
d-article a {
  color: #2780e3 !important;
  border-bottom: none !important;
}

d-article a:hover {
  color: #2780e3 !important;
  border-bottom: 2px solid !important;
}

d-byline {
  margin-left: -10% !important;
}

d-title {
  margin-left: -10%;
}

d-title h1{
  font-size: 45px;
  width: 130%;
}

d-article {
  margin-left: -10%;
}

p {
  width: 120%;
}

d-article h2 {
  width: 120%;
}

d-article h3 {
  width: 120%;
  font-size: 28px;
}

div.article-footer{
  width: 120%;
}

d-article div.sourceCode { 
  width: 120% !important;
}

d-article pre { 
  width: 120% !important;
}

div.l-body {
  width: 120% !important;
}

d-article table thead tr {
  height: 60px !important;
  width: 210px !important;
}

d-article table thead th {
  height: 60px !important;
  font-size: 22px !important;
  width: 210px !important;
}

d-article table tbody tr td {
  font-size: 21px !important;
  height: 60px !important;
  text-align: center !important;
  width: 210px !important;
}

div.l-body img {
    margin-right: 30% !important;
}

</style>

<head>
  <base target="_blank">
</head>

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = F, 
                      error = F, 
                      warning = F,
                      fig.align = "center")

```

<!-- Start of the article -->

## Introduction

Welcome to the first post of 2024! It's been a while since my last post last year (to be precise two months; maybe it's not really long?), and I feel excited to be back in the saddle and write something about ggplots. Hope we'll have another year of posts full of useful and fun topics! 

To kick things off, I'll be showing you how to create a time series chart in ggplots. A time series chart is essentially a type of line charts with "time" on the x-axis. Of course, you can simply treat time as a numeric variable and plot it as a usual line chart, but ggplot does offer a family of functions that work directly with time. So in this post, we're going to explore one of those functions and create a nice time series chart! 


## The data

In most previous posts, I used built-in R datasets as examples. But this time it's a bit different: I'll be using the data I collected myself! 

I've been recording the number of [black kites (_Milvus migrans_)](https://ebird.org/species/blakit1) along the Xindian river in Taipei, Taiwan from November 2022 to August 2023 (pretty much every day except for a few times when I was out of town), and this dataset consists of the daily black kite counts, the locations of the observations, and the weather conditions.

Let's take a quick look at the dataset:

```{r, fig.width = 5, fig.height = 4}
library(tidyverse)
library(readxl)

### Read the data
black_kite_raw <- read_xlsx("Black_Kite_Records.xlsx", sheet = 1)

### Organize the data
black_kite_clean <- black_kite_raw %>% 
  mutate(Date = ymd(Date)) %>% 
  select(Date, Site, Number, Weather)

head(black_kite_clean)

```
The majority of the observations came from one site "Huajiang Bridge", so we'll just focus on this particular site from now on. Below is a site map created via [ggmap](https://cran.r-project.org/web/packages/ggmap/readme/README.html):

```{r, fig.width = 5, fig.height = 4, out.width = "60%", fig.align = 'right'}
library(ggmap)

### Need to register an API key for Stadia Maps and for Google Maps
register_stadiamaps(key = "your key")
register_google(key = "your key")

register_stadiamaps(key = "69ccb61d-8886-4e2a-9ed1-fd5c67dab17b")
register_google(key = "AIzaSyBPa8CKmRUxaQEPRvy2C3comSZGp6AOyh8")

### Get the long-lat coordinates of the bridge
huajiang_bridge_lon_lat <- geocode("Huajiang Bridge, Wanhua District")

### Create a map
map_data <- get_stadiamap(bbox = c(left = huajiang_bridge_lon_lat$lon - 0.05, 
                                   bottom = huajiang_bridge_lon_lat$lat - 0.04, 
                                   right = huajiang_bridge_lon_lat$lon + 0.05, 
                                   top = huajiang_bridge_lon_lat$lat + 0.04), 
                          zoom = 14, 
                          maptype = "stamen_terrain")

ggmap(map_data) + 
  annotate(geom = "rect", 
           xmin = huajiang_bridge_lon_lat$lon - 0.01,
           ymin = huajiang_bridge_lon_lat$lat - 0.01,
           xmax = huajiang_bridge_lon_lat$lon + 0.01,
           ymax = huajiang_bridge_lon_lat$lat + 0.01,
           fill = NA,
           color = "red",
           linewidth = 1.5) + 
  theme_void()

```
<br>

## The time series plot

Now comes the main topic of the post: creating the time series line chart! I'll break down the process into four steps and walk through them one by one.

### (1) Summarize the data by week

Instead of plotting the daily kite counts, I decided to plot the weekly counts to better show the overall trend. To summarize the data by week, I first rounded the dates to the nearest weeks and summed the kite counts in each week. I also assigned a score to each of the four daily weather conditions and calculated the mean score for each week to represent the average weather condition.

At the end of the code, I added a week ID column by computing the day differences from the first week and dividing the differences by 7. This week ID column will be used for fitting a LOESS curve at step (2). Finally, I converted the rounded dates to datetimes for plotting purposes at step (3) and (4).

```{r, fig.width = 5, fig.height = 4}
### Summarize the data by week
black_kite_clean_week <- black_kite_clean %>% 
  filter(Site == "Huajiang_bridge") %>%
  mutate(Date_week = round_date(Date, "week")) %>%  # round the dates to the nearest weeks
  mutate(Weather_score = case_when(Weather == "Sunny" ~ 3,  # assign a score to each weather condition
                                   Weather == "Sunny_with_cloud" ~ 2,
                                   Weather == "Cloudy" ~ 1,
                                   Weather == "Rainy" ~ 0)) %>% 
  group_by(Date_week) %>% 
  summarise(Number_week = sum(Number),  # weekly kite counts
            Weather_week = mean(Weather_score)) %>%  # weekly average weather condition
  mutate(Week_id = as.double(Date_week - min(Date_week))/7) %>%   # week ID
  mutate(Date_week = as_datetime(Date_week))  # convert dates to datetimes

head(black_kite_clean_week)

```

### (2) Fit a LOESS curve to the weekly black kite counts

To show the trend, I fit a LOESS curve to the weekly black kite counts with a smaller span of 0.3 to capture more details. I then created a sequence of datetimes with an interval of six hours for model predictions, computed the week differences of these datetimes from the first datetime, and made the LOESS predictions based on these week differences.

```{r, fig.width = 5, fig.height = 4}
### Fit a LOESS curve to the weekly clack kite counts
loess_model <- loess(Number_week ~ Week_id, data = black_kite_clean_week, span = 0.3)

### Make predictions for the counts
library(modelr)  # for the function "add_predictions()"

loess_predictions <- tibble(Date_seq = seq(min(black_kite_clean_week$Date_week),
                                           max(black_kite_clean_week$Date_week), 
                                           by = "6 hour"),  # a sequence of datetimes for model predictions,
                            Week_id = as.numeric((Date_seq - min(black_kite_clean_week$Date_week))/86400)/7) %>%  # week differences from the first datetime
  add_predictions(loess_model)  # make the LOESS predictions

head(loess_predictions)

```

### (3) Create the time series chart

It's time to create the time series chart! This chart contains the points for the weekly kite counts, line segments joining the points, and the LOESS curve we got from step (2). I went a bit fancy by making the points blurry using the function `geom_point_blur()` from the package [`ggblur`](https://coolbutuseless.github.io/2020/02/11/introducing-the-ggblur-package/). I also drew a gradient fill background using the function `geom_rect_pattern` from the package [`ggpattern`](https://coolbutuseless.github.io/package/ggpattern/). (Note that I added the geom layers in a reversed order to have the points on the top, the lines in the middle, and the background at the very bottom.)

Remember I mentioned in the introduction that we would be using one of the functions that ggplot offers to work directly with time. That function is `scale_x_datetime()`, which allows for customizing the appearance of x-axis using date/time specifications. In the code below, I specified the x-axis limits using two datetimes, placed the x-axis breaks at an interval of one month ("date_breaks = "1 month" "), and labeled the x-axis using the R date/time format ("date_labels = "%b '%y" "; %b indicates the abbreviated month name and %y indicates the two-digit year; see [this documentation](https://rdrr.io/r/base/strptime.html) for more details).

```{r, fig.width = 10, fig.height = 4, out.width = "85%"}
library(ggpattern)  # for the function "geom_rect_pattern()"
library(ggblur)  # for the function "geom_point_blur()"

p_black_kite <- ggplot(black_kite_clean_week) + 
  geom_rect_pattern(aes(xmin = floor_date(min(black_kite_clean_week$Date_week), "month"), 
                        xmax = ceiling_date(max(black_kite_clean_week$Date_week), "month"), 
                        ymin = -Inf, 
                        ymax = Inf),
                    pattern_fill = "#99d6ff", pattern_fill2 = "#ccebff", pattern = "gradient") + 
  geom_line(aes(x = Date_week, y = Number_week), color = "black", alpha = 0.05) + 
  geom_line(data = loess_predictions, aes(x = Date_seq, y = pred),
            color = "grey60", linewidth = 2, lineend = "round") + 
  geom_point_blur(aes(x = Date_week, y = Number_week, color = Weather_week), 
                  size = 3, blur_size = 10) + 
  scale_x_datetime(limits = c(floor_date(min(black_kite_clean_week$Date_week), "month"),
                              ceiling_date(max(black_kite_clean_week$Date_week), "month")), 
                   expand = c(0, 3), date_breaks = "1 month", date_labels = "%b '%y") +
  scale_y_continuous(limits = c(-1, 23), breaks = seq(0, 20, 10), 
                     labels = c("0 ", "10", "20"), expand = c(0, 0)) + 
  scale_color_gradient(low = "#cce6ff", high = "#FFBA00") +
  theme_classic()

p_black_kite

```

### (4) Polish the chart








Interpretation



## Summary



Hope you learn something useful from this post and don't forget to leave your comments and suggestions below if you have any!


