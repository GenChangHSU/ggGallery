---
title: "Post #37. ggplot Map Series No.6: Cartograms in ggplots"
description: |
  Come and learn how to create cartograms in ggplots!
author:
  - name: Gen-Chang Hsu
date: 2024-10-08
output:
  distill::distill_article:
    self_contained: false
categories:
  - "2024"
  - "Map Series"
preview: ../../homepage_images/Post37.png
---

<!-- Webpage style -->

<style>
d-article a {
  color: #2780e3 !important;
  border-bottom: none !important;
}

d-article a:hover {
  color: #2780e3 !important;
  border-bottom: 2px solid !important;
}

d-byline {
  margin-left: -10% !important;
}

d-title {
  margin-left: -10%;
}

d-title h1{
  font-size: 45px;
  width: 130%;
}

d-article {
  margin-left: -10%;
}

p {
  width: 120%;
}

d-article h2 {
  width: 120%;
}

d-article h3 {
  width: 120%;
  font-size: 28px;
}

div.article-footer{
  width: 120%;
}

d-article div.sourceCode { 
  width: 120% !important;
}

d-article pre { 
  width: 120% !important;
}

div.l-body {
  width: 120% !important;
}

d-article table thead tr {
  height: 60px !important;
  width: 210px !important;
}

d-article table thead th {
  height: 60px !important;
  font-size: 22px !important;
  width: 210px !important;
}

d-article table tbody tr td {
  font-size: 21px !important;
  height: 60px !important;
  text-align: center !important;
  width: 210px !important;
}

div.l-body img {
    margin-right: 30% !important;
}

</style>

<head>
  <base target="_blank">
</head>

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = F, 
                      error = F, 
                      warning = F,
                      fig.align = "center")

```

<!-- Start of the article -->

## Introduction

In a [previous post](https://genchanghsu.github.io/ggGallery/posts/2023-03-09-post-25-ggplot-map-series-no1-basic-ggplot-maps/) in this Map Series, I wrote about how to create choropleth maps in ggplots: they are thematic maps that visualize the quantity of a focal variable across a geographical area (e.g., the population size of each country in the world) using different colors. Choropleth maps are easy to read and provide a quick glance at the spatial patterns of the focal variable.

Similar to choropleth maps, cartograms also visualize the quantity of a variable across a geographical area, but now the geographic size of the regions is altered to be proportional to the numerical values of the focal variable. This enhances the visual impacts of the maps. And in fact, it's easy to switch between a choropleth to a cartogram as they are both created from data with the same underlying structure!

In this post, I'll show you how to create cartograms in ggplots. We'll then make a variant of cartogram by adding pie charts to the map. Read on!


## A map of the world forest area

We're going to make a thematic map of the world forest area by country. The dataset can be downloaded from the website [Our World in Data](https://ourworldindata.org/forest-area): it contains the forest area in each country from 1990 to 2020.

First, let's create a choropleth map of the forest area in 2020. We retrieved the world base map from the [Natural Earth](https://www.naturalearthdata.com/) database using the package `rnaturalearth` and joined the forest data to the world map data to draw the choropleth map:

```{r, fig.width = 8, fig.height = 5, out.width = "80%"}
library(tidyverse)

### Read the forest area data
country_forest_area <- read_csv("Country_Forest_Area.csv")

country_forest_area_2020 <- country_forest_area %>% 
  filter(Year == 2020)

### Get a world base map from Natural Earth
library(rnaturalearth)
library(sf)  # for the function "st_transform()"

world_map <- ne_countries(type = "countries", returnclass = "sf", scale = 110) %>%
  st_transform(crs = "ESRI:54009")  # Mollweide projection

### Join the forest data to the map data
world_map_forest_area_2020 <- world_map %>% 
  mutate(Code = toupper(adm0_a3)) %>% 
  left_join(country_forest_area_2020, by = join_by("adm0_a3" == "Code"))

### Create a choropleth map of the world forest area by country
library(ggtext)  # for the function "element_markdown()"
library(colorspace)  # for the function "scale_fill_continuous_sequential()"

ggplot(world_map_forest_area_2020) + 
  geom_sf(aes(fill = `Forest area`)) + 
  scale_fill_continuous_sequential(palette = "Greens",
                                   breaks = seq(1e8, 8e8, by = 2e8), 
                                   labels = str_glue("<span>{c(1, 3, 5, 7)}×10^8^</span>"), 
                                   name = "<span>Forest area (hectares)</span>") + 
  coord_sf(expand = F) + 
  theme_bw() + 
  theme(panel.border = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_markdown(hjust = 0.5),
        legend.text = element_markdown(),
        legend.direction = "horizontal",
        legend.position = "top",
        legend.title.position = "top")

```

## Create the cartograms

Now we have the data at hand, it's time to create the cartograms! We'll use the handy extension package [`cartograms`](https://sjewo.github.io/cartogram/) to make the maps. This package offers two types of cartograms: a continuous one where the geographical sizes of the regions are altered to be proportional to the focal variable values, and a discrete one (also called a "Dorling cartogram") where the regions are redrawn as circles with the sizes proportional to the focal variable values.

Let's take a look at how it works:

```{r, fig.width = 7, fig.height = 8, out.width = "80%", cache = TRUE}
# install.packages("cartogram")  # install the package if you haven't
library(cartogram)

### Drop NA values for the forest area (otherwise the cartogram function will throw an error)
world_map_forest_area_2020 <- drop_na(world_map_forest_area_2020, "Forest area")

### Compute the continuous cartogram
### This might take a while to run!
cartogram_continuous <-  cartogram_cont(world_map_forest_area_2020, 
                                        weight = "Forest area", 
                                        itermax = 100)

### Compute the discrete Dorling cartogram
cartogram_dorling <- cartogram_dorling(world_map_forest_area_2020, 
                                       weight = "Forest area",
                                       itermax = 100)

### Visualize the cartograms
library(patchwork)

p_continuous_cartogram <- ggplot() + 
  geom_sf(data = cartogram_continuous, fill = "#2ca25f", color = alpha("#b2e2e2", 0.75)) +
  labs(title = "Continuous cartogram") + 
  theme_void() + 
  theme(plot.title = element_text(hjust = 0.5, vjust = 3, size = 14, color = "grey"),
        plot.background = element_rect(fill = "#045a8d", color = NA),
        plot.margin = margin(t = 15))

p_dorling_cartogram <- ggplot() + 
  geom_sf(data = world_map_forest_area_2020, fill = "#2ca25f", color = alpha("#b2e2e2", 0.5)) + 
  geom_sf(data = cartogram_dorling, fill = alpha("#dfc27d", 0.8), color = alpha("#a6611a", 0.8)) +   labs(title = "Dorling cartogram") + 
  theme_void() + 
  theme(plot.title = element_text(hjust = 0.5, vjust = 3, size = 14, color = "grey"),
        plot.background = element_rect(fill = "#045a8d", color = NA),
        plot.margin = margin(t = 15))

p_continuous_cartogram / plot_spacer() / p_dorling_cartogram + 
  plot_layout(heights = c(1, 0.1, 1))

```

As you can see, Russia has the largest share of the world's forest area, followed by Brazil, Canada, the United States, and China (the big five!).

## A variant of Dorling cartogram



```{r, fig.width = 7, fig.height = 5, out.width = "80%"}
### Calculate the percent forest area for each country
percent_forest_area_2020 <- world_map_forest_area_2020 %>% 
  # use st_area() to get the country areas in square meters and convert them to hectares
  mutate(country_area_hectares = st_area(world_map_forest_area_2020)/10000) %>%  
  mutate(percent_forest_area = as.numeric(`Forest area`/country_area_hectares*100)) %>% 
  select(Code, percent_forest_area) %>% 
  st_drop_geometry()

### Create pie charts of the percent forest area for the countries
percent_forest_area_2020_pie_charts <- percent_forest_area_2020 %>% 
  mutate(pie_chart = map(percent_forest_area, function(percent_forest_area){
    p_grob <- ggplotGrob(ggplot() + 
      geom_col(aes(x = 1, y = percent_forest_area), fill = alpha("#a6611a", 0.8), width = 1) + 
      scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) + 
      scale_x_continuous(limits = c(0.5, 1.5), expand = c(0, 0)) + 
      coord_polar(theta = "y") + 
      theme_void() +
      theme(plot.margin = unit(c(0, 0, 0, 0),"cm")))
  }))

### Get the centroids of the country circles from the Dorling cartogram
country_centroids <- cartogram_dorling %>% 
  mutate(country_centroid_lon = st_coordinates(st_centroid(cartogram_dorling)$geometry)[, 1],
         country_centroid_lat = st_coordinates(st_centroid(cartogram_dorling)$geometry)[, 2]) %>%
  select(Code, country_centroid_lon, country_centroid_lat) %>% 
  st_drop_geometry()

### Get the radii of the country circles from the Dorling cartogram
country_circle_radius <- cartogram_dorling %>%
  mutate(circle_area = as.numeric(st_area(cartogram_dorling)),
         circle_radius = as.numeric(sqrt(circle_area/pi))) %>% 
  select(Code, circle_radius) %>% 
  st_drop_geometry()

### Merge the centroids, the radii, and the pie charts into a dataframe
pie_chart_df <- country_centroids %>% 
  left_join(country_circle_radius, by = join_by("Code")) %>% 
  inner_join(., percent_forest_area_2020_pie_charts, by = join_by("Code"))
  
### Create the Dorling cartogram base map
p_dorling_cartogram_base_map <- ggplot() + 
  geom_sf(data = world_map_forest_area_2020, fill = "#2ca25f", color = alpha("#b2e2e2", 0.5)) + 
  geom_sf(data = cartogram_dorling, fill = alpha("#dfc27d", 0.8), color = alpha("#a6611a", 0.8)) +
  theme_void() + 
  theme(plot.background = element_rect(fill = "#045a8d", color = NA),
        plot.margin = margin(t = 15, b = 15))

### Add the pie charts to the Dorling cartogram
reduce(1:nrow(pie_chart_df), 
       .f = function(x, y){
         x + annotation_custom(grob = pie_chart_df$pie_chart[[y]],
                               xmin = pie_chart_df$country_centroid_lon[y] - pie_chart_df$circle_radius[y] * 1.2,
                               xmax = pie_chart_df$country_centroid_lon[y] + pie_chart_df$circle_radius[y] * 1.2,
                               ymin = pie_chart_df$country_centroid_lat[y] - pie_chart_df$circle_radius[y] * 1.2,
                               ymax = pie_chart_df$country_centroid_lat[y] + pie_chart_df$circle_radius[y] * 1.2)},
       .init = p_dorling_cartogram_base_map)

```
VOILÀ!

## Summary



Hope you learn something useful from this post and don't forget to leave your comments and suggestions below if you have any!




