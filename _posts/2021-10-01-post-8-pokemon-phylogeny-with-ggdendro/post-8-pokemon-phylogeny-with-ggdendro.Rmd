---
title: "Post #8. Pokemon phylogeny with ggdendro"
description: |
  Create a Pokemon phylogenetic tree in ggplot with the extension package ggdendro.
author:
  - name: Gen-Chang Hsu
date: 2021-10-01
output:
  distill::distill_article:
    self_contained: false
categories:
  - "2021"
preview: ../../homepage_images/Post8.png
draft: true
---


<!-- Webpage style -->
<style>
d-article a {
    color: #2780e3 !important;
    border-bottom: none !important;
}

d-article a:hover {
    color: #2780e3 !important;
    border-bottom: 2px solid !important;
}

d-byline {
    margin-left: -10% !important;
}

d-title {
    margin-left: -10%;
}

d-title h1{
    font-size: 45px;
    width: 130%;
}

d-article {
    margin-left: -10%;
}

p {
    width: 120%;
}

d-article h2 {
    width: 120%;
}

d-article h3 {
  width: 120%;
  font-size: 28px;
}

div.article-footer{
    width: 120%;
}

d-article div.sourceCode { 
    width: 120% !important;
}

d-article pre { 
    width: 120% !important;
}

div.l-body {
    width: 120% !important;
}

</style>

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = F, 
                      error = F, 
                      warning = F)

```

<!-- Start of the article -->

In this post, we are going to have a fun one: pokemon phylogeny!

My favoratie computer game back to my childhood

Currently around 860 ish species and belonging to 18 different type or functional groups

Previous stidies have done a phyloginey and this one would be a simple version of it.

EAch pok has their stats, including speed, attack. And pok in each type may have different properties nad characteristics, and so it would be interesign to do some clustering analysis to see their relatonship, perhaps gain some insights into their evolutionay history.


## Background
Pokémon is arguably one of the most popular video games among children, youth and adults alike. Despite extensive discussion on Pokémon game playing, there is still poor understanding of the basic biology of Pokémon. In this study, I analyzed the relationships between Pokémon stats, types and body traits (height and weight), and examined the phylogenetic relationships among different Pokémon types in terms of stats similarity.

Invented in 1996, Pokémon has become one of the most popular and successful video games in the past two decades (Bainbridge, 2014). It represents a world teeming with a high diversity of amazing creatures spreading across rich landscapes－they roam in the oceans, thrive in the mountains, soar high in the sky, and even share the life with humans in urban areas (Kittel, 2018). Pokémon not only inspires our imagination and creativity, but at the same time also reflects our understanding and passion of nature.

The most fascinating part of Pokémon for players is without doubt the excitement and challenge of Pokémon training and battling. However, although there has been an explosion of information and discussion regarding game playing, there is still a general lack of basic knowledge and detailed investigation of Pokémon characteristics such as stats, types and body traits. Since different Pokémon vary substantially in their stats and performance, which are the major concerns of players, it would be important to understand how various factors affect Pokémon stats so that players can have a better idea of the Pokémon they have collected, as well as what Pokémon are worthwhile to aim for.

what we are going to do





## Get the data
The first and most important thing is to have our Pokemon stats data at hand. We will scrape the data from the [Pokemon Database](https://pokemondb.net/) and tidy them a bit.    

```{r}
library(tidyverse)
library(rvest)

# Read the webpage contents
Pokemon_html <- read_html("https://pokemondb.net/pokedex/all")

# Extract and tidy the stats table
Pokemon_df <- Pokemon_html %>% 
  html_element("#pokedex") %>% 
  html_table() %>%
  select(-1, -4) %>%
  mutate(Type = str_extract(Type, pattern = "[:upper:]{1}[:lower:]*"))

head(Pokemon_df)

```
## Hierarchical cluster analysis 
Now we have the data ready, our next step is to perform hierarchical cluster analysis on the stats data to reveal the relationships among different types of Pokemon. Since the stats are measured in different units, we will standardize them and compute their means by Pokemon type. After that, we will then create a dissimilarity matrix based on Euclidean distance and call `hclust()` to do the hierarchical cluster analysis using the complete linkage method.

```{r}
# Standardize the stats
Pokemon_df_HC <- Pokemon_df %>% 
  mutate(across(HP:Speed, ~scale(.x))) %>%
  group_by(Type) %>% 
  summarise(across(HP:Speed, ~mean(.x)))

# Hierarchical cluster analysis  
Pokemon_clust <- Pokemon_df_HC[, -1] %>% 
  dist(., method = "euclidean") %>%
  hclust(., method = "complete")

Pokemon_clust$labels <- Pokemon_df_HC$Type

```
## Create the dendrogram
So far so good right? Time for our main topic today: creating the dendrogram! There are two main extension packages for visualizing tree-like objects in ggplots: [`ggdendro`](https://cran.r-project.org/web/packages/ggdendro/vignettes/ggdendro.html) and [`ggtree`](https://yulab-smu.top/treedata-book/index.html). `ggdendro` is a easy-to-use package with simple user-friendly functions, allowing for quick and basic visualizations of cluster data. On the other hand, `ggtree` is a more comprehensive and versatile package geared towards visualization and annotation of phylogenetic trees. It has a lot of nice features to offer, but at the same time requires more time and effort to really get the hang of the details.

To keep things simple, we will use `ggdendro` to visualize our cluster results. The function `dendro_data()` in the package extracts the line segments and labels from the cluster objects and returns the data as a list of dataframes.
We can then use these dataframes for plotting as well as customizing the appearance of the dendrograms, for example, changing the colors of the terminal branches and setting the labels of the terminal nodes.

```{r, fig.width = 5, fig.height = 5, out.width = "70%", fig.show = "hold"}
library(ggdendro)

# Extract the cluster data
Pokemon_dendro <- Pokemon_clust %>% 
  as.dendrogram() %>%
  dendro_data(., type = "rectangle")

# Extract the terminal branches
Pokemon_dendro_tb <- segment(Pokemon_dendro) %>%
                 filter(yend == 0) %>%
                 left_join(label(Pokemon_dendro)[, c(1, 3)], by = "x")

# The color palette for the Pokemon types
type_cols_pal <- c("Normal" = "#A8A77A", 
  "Fire" = "#EE8130", 
  "Water" = "#6390F0", 
  "Electric" = "#F7D02C",
  "Grass" = "#7AC74C",
  "Ice" = "#96D9D6",
  "Fighting" = "#C22E28",
  "Poison" = "#A33EA1",
  "Ground" = "#E2BF65",
  "Flying" = "#A98FF3",
  "Psychic" = "#F95587",
  "Bug" = "#A6B91A",
  "Rock" = "#B6A136",
  "Ghost" = "#735797",
  "Dragon" = "#6F35FC",
  "Dark" = "#705746",
  "Steel" = "#B7B7CE",
  "Fairy" =  "#D685AD")

# Create the dendrogram
Pokemon_dg <- ggplot() +
  geom_segment(data = segment(Pokemon_dendro), 
               aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_segment(data = Pokemon_dendro_tb, 
               aes(x = x, y = y, xend = xend, yend = yend, color = label),
               show.legend = F) +
  geom_point(data = label(Pokemon_dendro), 
             aes(x = x, y = y, label = label, colour = label, hjust = 0), 
             size = 3, show.legend = F) +
  geom_text(data = label(Pokemon_dendro), 
            aes(x = x, y = y-0.1, label = label, colour = label, hjust = 0), 
            size = 3, show.legend = F) + 
  coord_flip(clip = "off") + 
  scale_y_reverse(expand = c(0.12, 0)) + 
  scale_color_manual(values = type_cols_pal) + 
  theme_void()
  
Pokemon_dg
```

## Add Pokemon images
The above dendrogram looks pretty neat, but we can further spice it up a bit! Guess what ingredients we are going to add to the plot? Yes, **The Pokemon images**!

We will retrieve the images from the website and add them to the terminal nodes using the extension package `ggtext`. I have done a post on using `ggtext` before. Check it out [here](https://genchanghsu.github.io/ggGallery/posts/2021-07-10-post-5-awesome-text-display-with-ggtext/) if interested!

```{r, fig.width = 5, fig.height = 5, out.width = "70%", fig.show = "hold"}
library(ggtext)

# HTML <img> tags
Pokemon_images <- c(
"<img src = 'https://img.pokemondb.net/sprites/sword-shield/icon/dragonite.png' height = '15' width = '17'/>",
"<img src = 'https://img.pokemondb.net/sprites/sword-shield/icon/venusaur.png' height = '15' width = '17'/>",
"<img src = 'https://img.pokemondb.net/sprites/sword-shield/icon/blastoise.png' height = '15' width = '17'/>",
"<img src = 'https://img.pokemondb.net/sprites/sword-shield/icon/articuno.png' height = '15' width = '17'/>",
"<img src = 'https://img.pokemondb.net/sprites/sword-shield/icon/arbok.png' height = '15' width = '17'/>",
"<img src = 'https://img.pokemondb.net/sprites/sword-shield/icon/clefable.png' height = '15' width = '17'/>",
"<img src = 'https://img.pokemondb.net/sprites/sword-shield/icon/gengar.png' height = '15' width = '17'/>",
"<img src = 'https://img.pokemondb.net/sprites/sword-shield/icon/alakazam.png' height = '15' width = '17'/>",
"<img src = 'https://img.pokemondb.net/sprites/sword-shield/icon/umbreon.png' height = '18' width = '20'/>",
"<img src = 'https://img.pokemondb.net/sprites/sword-shield/icon/cramorant.png' height = '18' width = '20'/>",
"<img src = 'https://img.pokemondb.net/sprites/sword-shield/icon/pikachu.png' height = '25' width = '27'/>",
"<img src = 'https://img.pokemondb.net/sprites/sword-shield/icon/charizard.png' height = '15' width = '17'/>",
"<img src = 'https://img.pokemondb.net/sprites/sword-shield/icon/steelix.png' height = '15' width = '17'/>",
"<img src = 'https://img.pokemondb.net/sprites/sword-shield/icon/butterfree.png' height = '15' width = '17'/>",
"<img src = 'https://img.pokemondb.net/sprites/sword-shield/icon/persian.png' height = '15' width = '17'/>",
"<img src = 'https://img.pokemondb.net/sprites/sword-shield/icon/hitmonchan.png' height = '15' width = '17'/>",
"<img src = 'https://img.pokemondb.net/sprites/sword-shield/icon/dugtrio.png' height = '15' width = '17'/>",
"<img src = 'https://img.pokemondb.net/sprites/sword-shield/icon/onix.png' height = '15' width = '17'/>")

# Add the images to the dendrogram
Pokemon_dg + 
  scale_x_continuous(breaks = c(1:8, 9.1, 10, 11.2, 12:18), labels = Pokemon_images, position = "top") +
  theme(axis.text.y.right = element_markdown(vjust = 0.6)) 

```

A few interesting points:

1. There seems to be two major groups: Rock ~ Steel and Fire to Dragon

2. Rock, ground, fighting are closely related, ground-dweeling Pokemon

3. Fire and electric and and ice and water: as we might naturally think that they have similar properties and characteristics. 

4. Ghost and fairy: elusive and enigmatic Pokemon

5. However, quite suprisingly, grass and bugs are quite different, although they should have strong trophic connections. This is perhaps one is promary producer and the other is consumer


## Summary
We get the pokemon stats data and organize and perform hierarchical cluster analysis, and visualize the clustering result using ggdendro and dendextend, nd finally add some pokemon images to the leaves.

This is a rather fun post, but in fact you might have seen that we used lots of different methods and techniques to arrive at our final product. This is the beauty of a data science project: integrative approach!

This posts, we did some simple data analysis workdlow: from data colleciton adn import, data tidying and organizzaion, and modeling and visualzation, and finally data communication, which is the post you are reading right now! 
Perhaps this is the most important one! 


Hope you enjoy the reading and don't forget to leave your comments and suggestions below if you have any!

