---
title: "Post #14. Multiple color scales in ggplots"
description: |
  Using different color scales for multiple geom layers with `ggnewscale` and `relayer`
author:
  - name: Gen-Chang Hsu
date: 2022-04-24
output:
  distill::distill_article:
    self_contained: false
categories:
  - "2022"
preview: ../../homepage_images/Post14.png 
draft: true
---

<!-- Webpage style -->
<style>
d-article a {
    color: #2780e3 !important;
    border-bottom: none !important;
}

d-article a:hover {
    color: #2780e3 !important;
    border-bottom: 2px solid !important;
}

d-byline {
    margin-left: -10% !important;
}

d-title {
    margin-left: -10%;
}

d-title h1{
    font-size: 45px;
    width: 130%;
}

d-article {
    margin-left: -10%;
}

p {
    width: 120%;
}

d-article h2 {
    width: 120%;
}

d-article h3 {
  width: 120%;
  font-size: 28px;
}

div.article-footer{
    width: 120%;
}

d-article div.sourceCode { 
    width: 120% !important;
}

d-article pre { 
    width: 120% !important;
}

div.l-body {
    width: 120% !important;
}

div.l-body img {
    margin-right: 20% !important;
}

</style>

```{r setup, include = FALSE}
knitr::opts_chunk$set(message = F, 
                      error = F, 
                      warning = F)

```

<!-- Start of the article -->

## The problem

Sometimes we may want to use different "color" aesthetics for multiple geom layers. Sounds abstract? To make it clear, we'll begin with an example plot:

```{r, fig.width = 5, fig.height = 3, out.width = "70%"}
library(tidyverse)

ggplot(data = iris) + 
  geom_point(aes(x = Species, y = Sepal.Length, color = Sepal.Length), position = position_jitter(width = 0.1)) + 
  geom_boxplot(aes(x = Species, y = Sepal.Length), width = 0.5, outlier.color = NA, fill = NA) + 
  labs(y = "Sepal length (cm)") + 
  theme_classic(base_size = 14) + 
  scale_color_viridis_c(name = "Sepal length")

```
Here, we make a boxplot of the sepal length for the three species and add the original data points, which are mapped to a continuous color scale.

Now, what if we want to use different colors for the boxes? Let's try it out:

```{r, fig.width = 5, fig.height = 3, out.width = "70%", error = T, warning = T, message = T, fig.show = "hide"}
ggplot(data = iris) + 
  geom_point(aes(x = Species, y = Sepal.Length, color = Sepal.Length), position = position_jitter(width = 0.1)) + 
  geom_boxplot(aes(x = Species, y = Sepal.Length, color = Species), width = 0.5, outlier.color = NA, fill = NA) +  # map species to color
  labs(y = "Sepal length (cm)") + 
  theme_classic(base_size = 14) + 
  scale_color_viridis_c(name = "Sepal length") + 
  scale_color_brewer(name = "Species", palette = "Set1")  # color scale for species

```

Eek, it throws an error!!! The message says "Continuous value supplied to discrete scale", meaning that we cannot use another color scale (the discrete one for species) when there is already one (the continuous one for sepal length). 


## The solution

Thankfully, there are extension packages designed to solve this: [`ggnewscale`](https://eliocamp.github.io/ggnewscale/) and [`relayer`](https://github.com/clauswilke/relayer). I'll walk through them in the following sections. 

### (1) ggnewscale

Looking for a quick fix? `ggnewscale` is the go-to: The main function `new_scale_color()` is super straightforward and easy to use. Simply insert the function before a new color scale (in this case `scale_color_brewer()`). This will "decouple" the previous scale from the new scale so that the new one will not interfere with the previous one. Indeed, you can apply the principle to three or more color scales! 

By the way, note that `new_scale_color()` only starts a new **scale**, not **geom**! So if you put both geom_point() and geom_boxplot() before the function, the error will still occur (you can try this yourself)!

```{r, fig.width = 5.5, fig.height = 3.5, out.width = "70%"}
# install.packages("ggnewscale")  # install the package if you haven't
library(ggnewscale)

ggplot(iris) + 
  geom_point(aes(x = Species, y = Sepal.Length, color = Sepal.Length), position = position_jitter(width = 0.1)) + 
  scale_color_viridis_c(name = "Sepal length") + 
  new_scale_color() +
  geom_boxplot(aes(x = Species, y = Sepal.Length, color = Species), width = 0.5, outlier.color = NA, fill = NA) + 
  scale_color_brewer(palette = "Set1") + 
  labs(y = "Sepal length (cm)") + 
  theme_classic(base_size = 14)

```

### (2) relayer

The second way to handlie the problem is to use the function `rename_geom_aes()` in the package `relayer`. The basic idea of the function is to assign different "names" to the same aesthetic (e.g., color) as if they were different aesthetics so that these "pseudo-aesthetics" can be be treated independently and not interfere with each other. 

Confused? An example will make things clear! 

```{r, fig.width = 5.5, fig.height = 3.5, out.width = "70%"}
# devtools::install_github("clauswilke/relayer")  # install the package if you haven't
library(relayer)

ggplot(iris) +
  
  # the first color aesthetic mapping 
  # (note that you need to use "colour" instead of "color" for the function to work!)
  geom_point(aes(x = Species, y = Sepal.Length, colour = Sepal.Length), position = position_jitter(width = 0.1)) +
  
  # use the new name ("colour_for_species") for the second color aesthetic mapping   # and specify that "colour_for_species" corresponds to the color aesthetic in rename_geom_aes()
  (geom_boxplot(aes(x = Species, y = Sepal.Length, colour_for_species = Species), width = 0.5, outlier.color = NA, fill = NA) %>% 
     rename_geom_aes(new_aes = c("colour" = "colour_for_species"))) + 
  
  # the color scale for the first color aesthetic mapping ("colour")
  scale_color_viridis_c(aesthetics = "colour", name = "Sepal length") + 
  
  # the color scale for the second color aesthetic mapping ("colour_for_species")
  scale_color_brewer(aesthetics = "colour_for_species", palette = "Set1", name = "Species") + 
  labs(y = "Sepal length (cm)") + 
  theme_classic(base_size = 14)

```

There are a few more interesting things we can do with the `relayer` package. For example, suppose that we want to color the points by both sepal length and species (i.e., having three sets of continuous color gradients).     

```{r, fig.width = 5.5, fig.height = 3.5, out.width = "70%"}
# install.packages("RColorBrewer")  # install the package if you haven't
library(RColorBrewer)  
pal_species <- brewer.pal(3, "Set1")  # the point colors for the three species

ggplot(iris) +
  # specify "group = species" to use different colors for each species
  geom_point(aes(x = Species, y = Sepal.Length, col1 = Sepal.Length, col2 = Sepal.Length, col3 = Sepal.Length, group = Species), position = position_jitter(width = 0.1)) %>%
  
  # specify the color mappings to the corresponding species
    rename_geom_aes(new_aes = c("colour" = "col1", "colour" = "col2", "colour" = "col3"), aes(colour = case_when(group == 1 ~ col1, group == 2 ~ col2, group == 3 ~ col3))) +
  
  # geom layer for the boxplot
  (geom_boxplot(aes(x = Species, y = Sepal.Length, col4 = Species), width = 0.5, outlier.color = NA, fill = NA) %>% 
     rename_geom_aes(new_aes = c("colour" = "col4"))) + 
  
  # color scales for the points (three scales, each for one species)
  scale_color_gradient(aesthetics = "col1", low = "white", high = pal_species[1], name = "setosa", guide = guide_legend(order = 1, direction = "horizontal", title.position = "top")) +
  scale_color_gradient(aesthetics = "col2", low = "white", high = pal_species[2], name = "versicolor", guide = guide_legend(order = 2, direction = "horizontal", title.position = "top")) +
  scale_color_gradient(aesthetics = "col3", low = "white", high = pal_species[3], name = "virginica", guide = guide_legend(order = 3, direction = "horizontal", title.position = "top")) +
  
  # color scale for the boxplot
  scale_color_brewer(aesthetics = "col4", palette = "Set1", name = "Species", guide = guide_legend(order = 4, direction = "vertical")) + 
  
  # plot appearance
  labs(y = "Sepal length (cm)") + 
  theme_classic(base_size = 14) + 
  theme(legend.title.align = 0.5)

```

In the example above, the range of the three continuous legends is jointly determined by the sepal length of all three species (the three legends all have the same range). This works fine in this example, but may not work if the three species had quite different sepal lengths (imagine one species has its sepal ten times longer than that of the other two species, then the common legend range will be greatly distorted!)

Of course, it is possible to have individual legend range for each species (i.e., the ranges of the three continuous legends are independent of each other; each is determined by the sepal length of the respective species):

```{r, fig.width = 5.5, fig.height = 3.5, out.width = "70%"}
ggplot(mapping = aes(x = Species, y = Sepal.Length)) +
  
  # create three separate geom layers for the points so that the color mapping is independent of each other
  (geom_point(data = filter(iris, Species == "setosa"), aes(col1 = Sepal.Width), position = position_jitter(width = 0.1)) %>% 
     rename_geom_aes(new_aes = c("colour" = "col1"))) +
  (geom_point(data = filter(iris, Species == "versicolor"), aes(col2 = Sepal.Width), position = position_jitter(width = 0.1)) %>% 
     rename_geom_aes(new_aes = c("colour" = "col2"))) +
  (geom_point(data = filter(iris, Species == "virginica"), aes(col3 = Sepal.Width), position = position_jitter(width = 0.1)) %>% 
     rename_geom_aes(new_aes = c("colour" = "col3"))) +
  
  # geom layer for the boxplot
  (geom_boxplot(data = iris, aes(x = Species, y = Sepal.Length, col4 = Species), width = 0.5, outlier.color = NA, fill = NA) %>%
     rename_geom_aes(new_aes = c("colour" = "col4"))) +
  
  # color scales for the points (three scales, each for one species)
  scale_color_gradient(aesthetics = "col1", low = "white", high = pal_species[1], name = "setosa", guide = guide_legend(order = 1, direction = "horizontal", title.position = "top")) +
  scale_color_gradient(aesthetics = "col2", low = "white", high = pal_species[2], name = "versicolor", guide = guide_legend(order = 2, direction = "horizontal", title.position = "top")) +
  scale_color_gradient(aesthetics = "col3", low = "white", high = pal_species[3], name = "virginica", guide = guide_legend(order = 3, direction = "horizontal", title.position = "top")) +
  
  # color scale for the boxplot
  scale_color_brewer(aesthetics = "col4", palette = "Set1", name = "Species", guide = guide_legend(order = 4, direction = "vertical")) +
  
  # plot appearance
  labs(y = "Sepal length (cm)") + 
  theme_classic(base_size = 14) + 
  theme(legend.title.align = 0.5)

```
* **NOTE**
It seems that the package only works for discrete legend. Therefore, you have to force a continuous scale into a discrete scale (using `guide = guide_legend()`) if the mapped variable is continuous.

## Summary

To recap, we learned two packages that allow us to use different color scales for multiple geom layers: `ggnewscale` is the most convenient one for simple purposes; `relayer` is slightly more complicated but at the same time more versatile.

In this post, I use color aesthetic as an example (which I think is the most common situation). But the same principle applies to other aesthetics as well: fill, linetype, etc. 

That's it for now and as always, don't forget to leave your comments and suggestions below if you have any!










